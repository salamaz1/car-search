<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</title>

<link rel="stylesheet" href="style.css">

<!-- PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body>

<!-- Ø§Ù„Ø´Ø¹Ø§Ø± -->
<div class="logo-container">
  <img src="assets/logo.jpg" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ØµØ¯Ø§Ø±Ø©">
</div>

<h2>ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h2>

<input id="search" placeholder="Ø¨Ø­Ø« (Ù†ÙˆØ¹ØŒ Ù…ÙˆØ¯ÙŠÙ„ØŒ Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„ØŒ ØªÙƒÙ„ÙØ©...)">

<!-- Ø£Ø²Ø±Ø§Ø± Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª -->
<div id="brand-filters" class="brand-filters"></div>

<!-- Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª -->
<div class="counters">
  <div class="counter total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="count-total">0</span></div>
  <div class="counter sold">Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©: <span id="count-sold">0</span></div>
  <div class="counter available">ØºÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©: <span id="count-available">0</span></div>
</div>

<div id="cards" class="cards">
  <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
</div>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vR2sKJaXG_woDQOQge29zkhGyyWil3njTr8dmL9CqXdqV-e3Bi9JfTfqcLpdGMVPA/pub?output=csv";

let allData = [];
let currentBrand = "Ø§Ù„ÙƒÙ„";

const cardsDiv = document.getElementById("cards");
const searchInput = document.getElementById("search");
const brandFiltersDiv = document.getElementById("brand-filters");

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ù„ÙŠØ¨ÙŠ */
function formatLYD(value) {
  if (value === null || value === undefined || value === "") return "-";

  let text = value.toString().split(".")[0].split("Ù«")[0];
  const clean = text.replace(/[^\d]/g, "");
  if (clean === "") return "-";

  const number = parseInt(clean, 10);
  if (number <= 0) return "-";

  return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " Ø¯.Ù„";
}

/* Ù‚Ø±Ø§Ø¡Ø© CSV */
Papa.parse(CSV_URL, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: function(results) {
    allData = results.data;
    buildBrandFilters();
    applyFilters();
  }
});

/* Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ */
function buildBrandFilters(){
  const brands = [...new Set(
    allData
      .map(c => (c["Ø§Ù„Ù†ÙˆØ¹"] || "").trim())
      .filter(b => b !== "")
  )];

  brandFiltersDiv.innerHTML =
    `<button class="brand-btn active" data-brand="Ø§Ù„ÙƒÙ„">Ø§Ù„ÙƒÙ„</button>` +
    brands.map(b =>
      `<button class="brand-btn" data-brand="${b}">${b}</button>`
    ).join("");

  document.querySelectorAll(".brand-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".brand-btn")
        .forEach(b => b.classList.remove("active"));

      btn.classList.add("active");
      currentBrand = btn.dataset.brand;
      applyFilters();
    });
  });
}

/* Ø§Ù„Ø¨Ø­Ø« + ÙÙ„ØªØ±Ø© Ø§Ù„Ù†ÙˆØ¹ (Ù…ÙØµÙ„Ø­Ø© Ù„Ù‡ÙˆÙ†Ø¯Ø§) */
function applyFilters(){
  const searchText = searchInput.value.toLowerCase();
  const selectedBrand = currentBrand.trim().toLowerCase();

  const filtered = allData.filter(car => {
    const matchesSearch =
      Object.values(car).join(" ").toLowerCase().includes(searchText);

    const carBrand = (car["Ø§Ù„Ù†ÙˆØ¹"] || "").trim().toLowerCase();

    const matchesBrand =
      selectedBrand === "Ø§Ù„ÙƒÙ„" || carBrand === selectedBrand;

    return matchesSearch && matchesBrand;
  });

  updateCounters(filtered);
  render(filtered);
}

/* Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª */
function updateCounters(data){
  const total = data.length;
  const sold = data.filter(c =>
    (c["Ø§Ù„Ø­Ø¶ÙŠØ±Ø©"] || "").toLowerCase().includes("Ø¨ÙŠØ¹")
  ).length;

  document.getElementById("count-total").textContent = total;
  document.getElementById("count-sold").textContent = sold;
  document.getElementById("count-available").textContent = total - sold;
}

/* Ø§Ù„Ø¨Ø­Ø« */
searchInput.addEventListener("keyup", applyFilters);

/* Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
function render(data){
  cardsDiv.innerHTML = "";

  if (data.length === 0) {
    cardsDiv.innerHTML = "<div class='loading'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>";
    return;
  }

  data.forEach(car => {
    const status = (car["Ø§Ù„Ø­Ø¶ÙŠØ±Ø©"] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim();

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="card-header">
        <h3>${car["Ø§Ù„Ù†ÙˆØ¹"] || ""} - ${car["Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„"] || ""}</h3>
        <div class="vin">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„: ${car["Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„"] || "-"}</div>
        <span class="status-badge status-${status}">${status}</span>
      </div>

      <div class="card-cost">
        Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${formatLYD(car["Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©"])}
      </div>

      <div class="details">
        ${Object.keys(car).map(k => `
          <div class="detail-row">
            <span class="label">${k}</span>
            <span class="value">
              ${
                k.includes("Ø³Ø¹Ø±") || k.includes("ØªÙƒÙ„ÙØ©") ||
                k.includes("Ù…ØµØ§Ø±ÙŠÙ") || k.includes("Ø¹Ù…ÙˆÙ„Ø©") ||
                k.includes("Ø±Ø¨Ø­")
                ? formatLYD(car[k])
                : car[k]
              }
            </span>
          </div>
        `).join("")}
      </div>
    `;

    card.onclick = () => card.classList.toggle("open");
    cardsDiv.appendChild(card);
  });
}
</script>

</body>
</html>
